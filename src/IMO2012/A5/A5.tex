\documentclass{article}

\usepackage{amsmath, amsfonts, amssymb, amsthm}
\usepackage{hyperref}
\usepackage{float}

\setlength{\parindent}{0pt}
\setlength{\parskip}{5pt}

\newcommand{\F}{\mathbb{F}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}

\DeclareMathOperator{\rchar}{char}

\newtheorem{lemma}{Lemma}
\newtheorem*{claim}{Claim}

\title{IMO 2012 A5}
\author{}
\date{}

\begin{document}

\maketitle





\section*{Problem}

Let $R$ be a commutative ring and $S$ be a division ring.
Find all functions $f : R \to S$ such that, for any $x, y \in R$,
\[ f(xy + 1) - f(x + y) = f(x) f(y). \tag{*}\label{2012a5-eq0} \]

\textit{
    Note: In the solution below, we will only completely solve the problem for the case $R = \R$.
    We will present some cases in generality; the rest will be done with the assumption $R = \R$.}





\section*{Answer}

The solutions can be described via the following nine classes of functions.
For the $8^{\text{th}}$ class, $\phi, \psi \in S$ satisfies $\phi + \psi = 1$ and $\phi \psi = -1$.
The map into the intermediate ring is necessarily a ring homomorphism in this context.

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
    \hline
    No. & Intermediate ring & Map to $S$ \\ \hline
    1 & $0$ & $0 \mapsto 0$ \\ \hline
    2 & $S$ & $x \mapsto x - 1$ \\ \hline
    3 & $\F_3$ & $[0, 1, 2] \mapsto [-1, 0, 1]$ \\ \hline
    4 & $S$ & $x \mapsto x^2 - 1$ \\ \hline
    5 & $\F_3$ & $[0, 1, 2] \mapsto [-1, 0, 0]$ \\ \hline
    6 & $\Z/4\Z$ & $[0, 1, 2, 3] \mapsto [-1, 0, 1, 0]$ \\ \hline
    7 & $\F_2$ & $[0, 1] \mapsto [-1, 0]$ \\ \hline
    8 & $\F_4$ & $[0, 1, X, X + 1] \mapsto [-1, 0, \phi, \psi]$ \\ \hline
    9 & $\F_2[X]/\langle X^2 \rangle$ & $[0, 1, X, X + 1] \mapsto [-1, 0, 1, 0]$ \\ \hline
\end{tabular}
\end{table}





\section*{Solution}

Through this solution, we assume that $R$ is an arbitrary ring, except when specified.
We also assume that $S$ is a domain, though not necessarily commutative in most cases.

We start with some small observations.
Plugging $x = y = 1$ into~\eqref{2012a5-eq0} yields $f(1) = 0$.
Now plugging $y = 0$ into~\eqref{2012a5-eq0} yields $-f(x) = f(x) f(0)$ for all $x \in R$.
This means that either $f \equiv 0$ or $f(0) = -1$.
From now on, we assume that $f(0) = -1$.

Plugging $y = -1$ into~\eqref{2012a5-eq0} yields $f(1 - x) - f(x - 1) = f(x) f(-1)$ for all $x \in R$.
This also implies $f(-x) - f(x) = f(x + 1) f(-1)$ for all $x \in R$.
In particular, the case $f(-1) = 0$ yields that $f$ is even.

Before we split into cases, we prove some lemmas.
As the solution classes involve homomorphisms into explicit rings, we want to take quotients.
The idea of the lemmas is that we can pass on to the quotients of $R$.
For convenience, from now on we assume that $R$ is commutative and that $S$ is a domain.

\begin{lemma}\label{2012a5-1}
For any $c \in R$, we have $f(c + x) = -f(c) f(x)$ for all $x \in R$ if and only if $f(cx + 1) = 0$ for all $x \in R$.
The set $J$ of such $c$ forms an ideal of $R$.
\end{lemma}
\begin{proof}
The first part is clear since $f(cx + 1) - f(c + x) = f(c) f(x)$.
For the second part, closure under addition is easy to prove from the equation $f(c + x) = -f(c) f(x)$.
Meanwhile, closure under multiplication in $R$ follows from the equation $f(cx + 1) = 0$.
Finally, $f(1) = 0$ yields that $0 \in J$.
\end{proof}

\begin{lemma}\label{2012a5-2}
Let $I = \{c \in R : \forall x \in R, f(c + x) = f(x)\}$ and $J = \{c \in R : \forall x \in R, f(cx + 1) = 0\}$.
Then $c \in I$ if and only if $c \in J$ and $f(c) = -1$.
The set $I$ is an ideal of $R$.
\end{lemma}
\begin{proof}
If $c \in I$, then $f(c) = f(0) = -1$, and $c \in J$ holds by the previous lemma.
The converse is also easy to check.
Now we prove that $I$ is an ideal of $R$.
It is easily a subgroup of $R$, so we just need to prove closure under multiplication over $R$.

Let $c \in I$ and $x, y \in R$.
Since $f(c + z) = f(z)$ for all $z \in R$,~\eqref{2012a5-eq0} yields $f(x(c + y) + 1) = f(xy + 1)$ for all $y \in R$.
Since $J$ is an ideal containing $I$, we have $cy \in J$.
That means we have $-f(cx) f(xy + 1) = f(xy + 1)$ for all $x, y \in R$.
Fixing $x$, this implies either $f(cx) = -1$ or $f(xy + 1) = 0$ for all $y \in R$.
Note that $cx \in J$ since $c \in I \subseteq J$.
Thus, we get either $cx \in I$ or $x \in J$.
That is, if $x \notin J$, then $cx \in I$.

Finally, take an arbitrary $c \in I$ and $x \in R$.
If $x \notin J$, then $cx \in I$ as we've seen above.
If $x \in J$, then $x - 1, 1 \notin J$, so $c(x - 1), c \in I$ and thus $cx \in I$.
\end{proof}

For any $a, b \in R$ such that $a - b \in I$, it is clear that $f(a) = f(b)$.
Thus, we get an induced map $g : R/I \to S$ such that $f = g \circ \phi$, where $\phi : R \to R/I$ is the quotient map.
Since $\phi$ is surjective, one can check that $g$ satisfies~\eqref{2012a5-eq0} as well.
Thus, from now on, we can WLOG assume that $I = \{0\}$.

The following lemma is only going to be useful in Case 2.
However, we put it here since it will be used in two subcases.
The lemma says that we have a very strong structure on $R$ if $I \subsetneq J$.

\begin{lemma}\label{2012a5-3}
Let $I$ and $J$ as in Lemma~\ref{2012a5-2}.
Suppose that $I \subsetneq J$, and fix some $c \in J \setminus I$.
Then for any $x \in R$, $x$ is congruent to $0$, $1$, $c$, or $c + 1$ modulo $I$.
\end{lemma}
\begin{proof}
First note that $[J : I] = 2$.
One can check manually that if $c, d \in J \setminus I$, then $c - d \in I$.
In particular, every element of $J$ is congruent to $0$ or $c$ modulo $I$.
It suffices to show that for any $x \in R$, either $x \in J$ or $x - 1 \in J$.
The main claim is that, if $x \notin J$, then $xc \notin I$.

First suppose that the claim holds.
Then given $x \notin J$, since $c \in J \setminus I$, we have $xc \in J \setminus I$.
This implies $(x - 1) c = xc - c \in I$.
The claim again implies that $x - 1 \in J$, as desired.

We now prove the claim.
Since $c \in I \setminus J$, we have $f(c) = 1$ and for all $y \in R$,
\[ f(x(c + y) + 1) = f(x + c + y) + f(x) f(c + y) = -(f(x + y) + f(x) f(y)) = -f(xy + 1). \]
On the other hand, since $J$ is an ideal, we have $xc \in J$.
In particular, $f(x(c + y) + 1) = f(xc + xy + 1) = -f(xc) f(xy + 1)$.
For $x \notin J$, we can pick $y \in R$ such that $f(xy + 1) \neq 0$.
Cancelling out $f(xy + 1)$ yields $f(xc) = 1$.
Note that $1 \neq -1$ in $S$ in our case; otherwise $c \in I$ as $f(c) = 1 = -1$.
This implies $xc \in J \setminus I$, as desired.
\end{proof}

We now split into two cases: $f(-1) \neq 0$ and $f(-1) = 0$.
The above equation is only saying that $f$ is even if $f(-1) = 0$.
We start with the former case.



\subsection*{Case 1: $f(-1) \neq 0$.}

The equation $f(-x) - f(x) = f(x + 1) f(-1)$ now easily yields
\[ f(1 - x) = -f(1 + x). \tag{1.1}\label{2012a5-eq1-1} \]
Now plug $x = 2$ into~\eqref{2012a5-eq0}.
Using~\eqref{2012a5-eq1-1}, we have $f(2) = -f(0) = 1$ and $f(y + 2) = -f(-y)$, so
\[ f(2y + 1) = f(y) - f(-y) = -f(y + 1) f(-1). \tag{1.2}\label{2012a5-eq1-2} \]
By replacing $(x, y)$ with $(-x, -y)$ in~\eqref{2012a5-eq0}, we get $f(xy + 1) - f(-x - y) = f(-x) f(-y)$.
Subtracting by~\eqref{2012a5-eq0} and applying~\eqref{2012a5-eq1-2} yields
\[ -f(x + y + 1) f(-1) = f(x + y) - f(-x - y) = f(-x) f(-y) - f(x) f(y). \tag{1.3}\label{2012a5-eq1-3} \]

For $x = y$,~\eqref{2012a5-eq1-2} yields $(f(-x) - f(x)) f(-1) = f(-x)^2 - f(x)^2$.
Since $f(-x)$ and $f(x)$ commute, $f(-x)^2 - f(x)^2 = (f(-x) - f(x))(f(-x) + f(x))$.
Thus, for any $x \in R$, we have either $f(-x) = f(x)$ or $f(-x) + f(x) = f(-1)$.
Since $f(-x) - f(x) = f(x + 1) f(-1)$, the former is equivalent to $f(x + 1) = 0$.
Replacing $x$ with $x - 1$, we get
\[ f(x) \neq 0 \implies f(x - 1) - f(x + 1) = f(-1). \tag{1.4}\label{2012a5-eq1-4} \]

On the other hand, suppose that $f(x) = 0$.
Replace $x$ with $x - 1$ in~\eqref{2012a5-eq1-3}, then plug $y = x$.
We get $f(2x - 1) - f(1 - 2x) = f(1 - x) f(-x)$.
By~\eqref{2012a5-eq1-2}, $f(2x - 1) = f(x - 1) - f(1 - x) = -f(x) f(-1) = 0$, and $f(1 - 2x) = -f(1 - x) f(-1)$.
Thus $f(x - 1) = f(1 - x)$ and $f(1 - x) f(-x) = f(1 - x) f(-1)$.
In particular this also means $f(-x) f(1 - x) = f(-1) f(1 - x)$.
Since $f(1 - x) = -f(x + 1)$, we get $f(-x) f(x + 1) = f(-1) f(x + 1)$.
By plugging $y = -x - 1$, we get $f(-1) = f(-x) f(x + 1) = f(-1) f(x + 1)$.
Since $f(-1) \neq 0$, this implies $f(x + 1) = 1$.
In summary,
\[ f(x) = 0 \implies f(x + 1) = 1 \text{ and } f(x - 1) = -1. \tag{1.5}\label{2012a5-eq1-5} \]

\begin{claim}
$f(-1) \in \{-2, 1\}$.
\end{claim}
\begin{proof}
Due to~\eqref{2012a5-eq1-1}, the claim is equivalent to $f(3) \in \{-1, 2\}$.
Now denote $C = f(3) = -f(-1)$ for convenience.
Since $f(0) = -1$, we have $f(2) = 1$.
By the equation $f(x + 2) + f(x) = C f(x + 1)$, we have $f(4) = C^2 - 1$ and $f(5) = C^3 - 2C$.
Plugging $x = y = 2$ into~\eqref{2012a5-eq0} yields $C^3 - 2C - (C^2 - 1) = 1$, which is equivalent to $C(C + 1)(C - 2) = 0$.
This proves the claim, since $C = -f(-1) \neq 0$.
\end{proof}


\subsubsection*{Subcase 1.1: $f(-1) = -2 \neq 0$.}

In particular $\rchar(S) \neq 2$.

The corresponding class of solutions is class 2.
We claim that $f + 1 : R \to S$ is a ring homomorphism.
    
Combining~\eqref{2012a5-eq1-4} and~\eqref{2012a5-eq1-5} yields $f(x - 1) - f(x + 1) = -2$ for all $x \in R$.
Using~\eqref{2012a5-eq1-1} and replacing $x$ with $x + 1$, we can rewrite this as $f(x) + f(-x) = -2$ for all $x \in R$.
On the other hand, we have $f(x) - f(-x) = 2 f(x + 1)$ for all $x \in R$.
Adding the two equations yields $2 f(x) = 2 (f(x + 1) - 1)$ for all $x \in R$.
Since $\rchar(S) \neq 2$, this yields $f(x + 1) = f(x) + 1$ for all $x \in R$.

Assuming that $f + 1$ is additive, it is easy to show that $f + 1$ is multiplicative.
Indeed, the original equality yields
\[ f(xy) + 1 = f(x) f(y) + f(x) + f(y) + 1 = (f(x) + 1)(f(y) + 1). \]
It remains to show that $f + 1$ is additive, i.e., $f(x + y) = f(x) + f(y) + 1$ for all $x, y \in R$.
We go back to~\eqref{2012a5-eq1-3} and use the equality $f(x) + f(-x) = -2$, giving us:
\[ 2 f(x + y + 1) = (f(x) + 2) (f(y) + 2) - f(x) f(y) = 2 (f(x) + f(y) + 2). \]
Again, $\rchar(S) \neq 2$, so $f(x + y) + 1 = f(x + y + 1) = f(x) + f(y) + 2$.
We are done.


\subsubsection*{Subcase 1.2: $f(-1) = 1 \neq -2$.}

In particular, $\rchar(S) \neq 3$.

The corresponding class of solutions is class 3.
Using Lemma~\ref{2012a5-2}, we can assume that $I = 0$.
Then it suffices to show that $R \cong \F_3$, and $f : \F_3 \to S$ is defined by the corresponding map.
We already know that $f(-1) = 1$, $f(0) = -1$, and $f(1) = 0$.
So, it now suffices to show that $R \cong \F_3$.

First, we prove that $f(c + 1) = 0$ implies $c = 0$.
We have $f(1 - c) = 0$ by~\eqref{2012a5-eq1-1}.
Then~\eqref{2012a5-eq1-5} yields $f(c) = f(-c) = -1$.
Plugging $(x, y) \to (c, x - 1)$ yields $f(c + x) = f(x)$ for all $x \in R$.
Since $I = 0$, this implies $c = 0$, as desired.

The equation~\eqref{2012a5-eq1-2} and~\eqref{2012a5-eq1-1} yields $f(x - 1) + f(x) + f(x + 1) = 0$ for all $x \in R$.
In particular, this implies that $3 \in I$, thus $R$ either has characteristic $3$ or is trivial.
The latter is impossible since $f(0) = -1 \neq 0 = f(1)$.
To show that $R \cong \F_3$, it remains to show that $R = \{-1, 0, 1\}$.

Fix some $x \in R$, and suppose that $x \notin \{-1, 0, 1\}$.
Then $f(x - 1), f(x), f(x + 1)$ are all non-zero.
By~\eqref{2012a5-eq1-5}, $f(x - 1) - f(x + 1) = f(x + 1) - f(x) = f(x) - f(x - 1) = 1$.
Adding all three yields $3 = 0$ in $S$, which is impossible by the subcase assumption, $1 \neq -2 \in S$.
We are done with this subcase.



\subsection*{Case 2: $f(-1) = 0$.}

Recall that~\eqref{2012a5-eq0} with $y = -1$ implies that $f$ is even.
We derive some general equalities and compute $f(2)$.
Replacing $y$ with $-y$ now gives us
\[ f(xy - 1) - f(x - y) = f(x) f(y). \tag{2.1}\label{2012a5-eq2-1} \]

Plugging $y = 2$ into~\eqref{2012a5-eq0} gives us $f(2x + 1) = f(x) f(2) + f(x + 2)$.
This also means $f(2x + 1) = f(2(-x - 1) + 1) = f(-x - 1) f(2) + f(-x + 1) = f(x + 1) f(2) + f(x - 1)$.
In particular, this gives us
\[ f(x + 2) = (f(x + 1) - f(x)) f(2) + f(x - 1). \tag{2.2}\label{2012a5-eq2-2} \]

Another useful identity can be obtained as follows.
Notice that for any $x \in R$, $x(x + 1) - 1 = (x - 1)(x + 2) + 1 = x^2 + x - 1$.
Thus combining~\eqref{2012a5-eq2-1} and~\eqref{2012a5-eq0} gives us
\[ f(x - 1) f(x + 2) + f(2x + 1) = f(x) f(x + 1) + f(-1) = f(x) f(x + 1), \]
\[ f(x) f(x + 1) - f(x - 1) f(x + 2) = f(x) f(2) + f(x + 2). \tag{2.3}\label{2012a5-eq2-3} \]

\begin{claim}
We have $f(2) \in \{-1, 0, 1, 3\}$.
\end{claim}
\begin{proof}
Recall that $f(0) = -1$ and $f(-1) = f(1) = 0$.
For convenience, let $M = f(2)$.
Plugging $x = y = 2$ into~\eqref{2012a5-eq2-1} gives us $f(3) = M^2 - 1$.
Using~\eqref{2012a5-eq2-2} with $x = 2$ and $x = 3$ respectively gives us
\[ f(4) = (f(3) - M) M, \quad f(5) = (f(4) - f(3) + 1) M. \]
On the other hand,~\eqref{2012a5-eq0} gives us $f(5) = f(4) + M^2$.
So we have $(f(4) - f(3) + 1) M = f(4) + M^2 = (f(3) - M) M + M^2 = f(3) M$.

Now suppose that $M \neq 0$.
Since $S$ is a domain, we can cancel $M$ out and get $f(4) + 1 = 2 f(3)$.
On the other hand, $f(4) + 1 = f(3) M - M^2 + 1 = f(3) M - f(3) = f(3) (M - 1)$.
So that means $f(3) (M - 3) = 0$, which implies either $M = 3$ or $f(3) = 0$.
The latter yields $M = \pm 1$ since $f(3) = M^2 - 1$.
We are done.
\end{proof}


\subsection*{Subcase 2.1: $f(2) = 0 \neq 3$.}

In particular, $\rchar(S) \neq 3$.

The corresponding class of solutions is class 5.
Since we already know the value of $f(0)$, $f(1)$, and $f(-1)$, it suffices to show that $R/I \cong \F_3$.
WLOG let $I = 0$.

Since $f(2) = 0$,~\eqref{2012a5-eq2-2} yields $3 = 0$ in $R$.
Now~\eqref{2012a5-eq2-3} yields $f(x) f(x + 1) = f(x - 1)^2 + f(x - 1)$ for all $x \in R$.
Similarly, we have $f(x) f(x - 1) = f(x + 1)^2 + f(x + 1)$ and $f(x + 1) f(x - 1) = f(x)^2 + f(x)$.
Note that, since $x$, $x - 1$, and $x + 1$ pairwise commute, so are $f(x)$, $f(x - 1)$, and $f(x + 1)$.
Thus subtracting gives us $f(x) (f(x + 1) - f(x - 1)) = (f(x + 1) + f(x - 1) + 1)(f(x - 1) - f(x + 1))$.
This means either $f(x + 1) = f(x - 1)$ or $f(x) + f(x + 1) + f(x - 1) = -1$.

To proceed further, we need some rather tricky steps.
The first step is the following claim.

\begin{claim}
Given $c \in R$ such that $f(c + 1) = f(c - 1) = 0$, we have $c = 0$.
\end{claim}
\begin{proof}
It suffices to show that $f(c + y) = f(y)$ for all $y \in R$.
By~\eqref{2012a5-eq0} and $f(c + 1) = f(c - 1) = 0$, we have $f(y(c + 1) + (c - 1)) = f(y(c - 1) + (c + 1)) = f(y(c^2 - 1) + 1)$.
We can rewrite the equation as $f((y + 1)(c + 1) + 1) = f((y + 1)(c - 1) - 1)$.
By~\eqref{2012a5-eq0} and~\eqref{2012a5-eq2-1}, we get $f(y + c + 2) = f(y - c + 2)$ for any $y \in R$.
The claim follows by replacing $y$ with $y - 2 + 2c$.
\end{proof}

In particular, we can now show that $f(x) + f(x + 1) + f(x - 1) = -1$ always holds.
Indeed, if not, then we have $f(x) = f(x + 1) = f(x - 1)$.
Then $f(x) f(x + 1) = f(x - 1)^2 + f(x - 1)$ forces the common value to be zero.
The above claim now gives a contradiction.

Next we show that $f(x) \in \{0, -1\}$ for all $x \in R$.
We will use the equality $f(x + 1) f(x - 1) = f(x)^2 + f(x)$.
By~\eqref{2012a5-eq0} and~\eqref{2012a5-eq2-1},
\[ f(x^2) = f(x + 1) f(x - 1) + f(2x) = f(x)^2 + f(x) + f(x) = f(x)^2 + 2 f(x), \]
\[ f(x^2 + 1) = f(x)^2 + f(2x) = f(x)^2 + f(x), \quad f(x^2 - 1) = f(x)^2 - 1. \]
Summing all three equalities yield $-1 = f(x^2) + f(x^2 + 1) + f(x^2 - 1) = 3 f(x)^2 + 3 f(x) - 1$.
That is, $3 f(x) (f(x) + 1) = 0$.
Since $3 \neq 0$ in $S$, we get $f(x) \in \{0, -1\}$.

We now show that $R = \{-1, 0, 1\}$.
This is easy to see if two of $f(x)$, $f(x + 1)$, and $f(x - 1)$ equals zero.
So now suppose otherwise, that at most one of them equals zero.
If exactly one of the three expressions is equal to zero, then $-1 = f(x) + f(x + 1) + f(x - 1) = -2$.
If none of them equals zero, then $f(x) = f(x + 1) = f(x - 1) = -1$, contradicting $f(x) f(x + 1) = f(x - 1)^2 + f(x - 1)$.
Thus every element of $R$ is either $-1$, $0$, and $1$.
Since $1 \neq 0$ in $R$ (due to $f(1) \neq f(0)$), this shows that $R \cong \Z/3\Z$, as desired.


\subsection*{Subcase 2.2: $f(2) = 1 \neq -1$.}

In particular, $\rchar(S) \neq 2$.

The corresponding class of solutions is class 6.
We will use Lemma~\ref{2012a5-3} to conclude that $R/I \cong \Z/4\Z$.
This suffices, as we have computed $f(0)$, $f(1)$, $f(2)$, and $f(-1)$ before.
By the lemma, it suffices to prove that $f(2) \in J$.
That is, $f(2x + 1) = 0$ for all $x \in R$.

Since $f(2) = 1$,~\eqref{2012a5-eq2-2} implies $f(x + 2) + f(x) = f(x + 1) + f(x - 1)$ for all $x \in R$.
From here, it is easy to see that $4 \in I$, i.e., $f(x + 4) = f(x)$ for all $x \in R$.
Now notice that $f(2x + 1) = f(x + 2) + f(x) = f(x + 1) + f(x - 1) = f(2x - 1)$ for all $x \in R$.
Thus we get $f(4x + 1) = f(2x + 1) + f(2x - 1) = 2 f(2x + 1)$.
But since $4 \in I$, we have $f(4x + 1) = 0$.
Since $\rchar(S) \neq 2$, this implies $f(2x + 1) = 0$, as desired.


\subsection*{Subcase 2.3: $f(2) = 3 \neq 1$.}

...


\subsection*{Subcase 2.4: $f(2) = -1$.}

...



\section*{Implementation details}

...



\end{document}
