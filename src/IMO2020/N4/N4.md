# IMO 2020 N4, Generalized Version

Fix an odd positive integer $p$.
For any integer $n$, let $d_p(n) \in \{0, 1, \ldots, p - 1\}$ be the remainder when $n$ is divided by $k$, and denote $F_p(n) = n + d_p(n)$.

1. A pair $(a_1, a_2)$ of non-negative integers is called *$p$-alternating* if $F_p^n(a_1) > F_p^n(a_2)$ for infinitely many $n$ and $F_p^n(a_1) < F_p^n(a_2)$ for infinitely many $n$.
We call $p$ *good* if there exists a $p$-alternating pair $(a_1, a_2)$ with $a_1$ and $a_2$ coprime with $p$.
Prove that $p$ is good if and only if $p \notin \{1, 3, 7, 15\}$.

2. We say that $p$ is *balanced* if there exists no positive integers $a_1 > a_2$ coprime with $p$ such that $F_p^n(a_1) < F_p^n(a_2)$ for all $n \geq 1$.
Given that $p$ is a prime, prove that $p$ is balanced if and only if the order of $2$ modulo $p$ is even.



# Solution

Let $T$ denote the order of $2$ modulo $p$.
For both parts, we need to set up some notation.
For any $n \geq 0$, let $S_p(n) = \displaystyle \sum_{k = 0}^{T - 1} d_p(2^k n)$.
By order definition, $d_p(2^T n) = d_p(n)$, so one can check that $S_p(2n) = S_p(n)$.
Clearly, $S_p(n) = S_p(d_p(n))$ and $d_p(F_p(n)) = d_p(2n)$, so we also get $S_p(F_p(n)) = S_p(n)$.
In particular, we can prove by induction on $k$ that for all $k, r \geq 0$,
$$ F_p^{kT}(n) = n + k S_p(n). \tag{*} $$
The above equation is the key equation to solve both parts.
One remark to note is that one can show that $F_p$ is injective.
In particular, when $a_1 \neq a_2$, we have $F_p^n(a_1) \neq F_p^n(a_2)$ for all $n \geq 0$.

The following lemma is the main ingredient in finding balanced odd numbers.
However, it turns out to be useful in formalizing the solution for part 1 as well.

> __Lemma__:
> For any positive integers $a$ and $b$ such that $S_p(a) < S_p(b)$, there exists $N \geq 0$ such that $F_p^n(a) < F_p^n(b)$ for all $n \geq N$.
>
> __Proof__:
> Since $S_p(a) < S_p(b)$, there exists $K$ large enough such that $a + (K + 1) S_p(a) < b + K S_p(b)$.
> Due to (*), this is just saying that $F_p^{(K + 1)T}(a) < F_p^{KT}(b)$.
> We claim that $N = KT$ works.
>
> Fix some $n \geq KT$.
> We can write $n$ as $kT + r$, where $k \geq K$ and $0 \leq r < T$.
> One can easily compute and get $F_p^{(k + 1)T}(a) < F_p^{kT}(b)$ since $k \geq K$.
> Then, since $F_p(x) \geq x$ for all $x$ and $kT \leq n < (k + 1)T$, we get $F_p^n(a) < F_p^{(k + 1)T}(a) < F_p^{kT}(b) \leq F_p^n(b)$.
> The claim is proved.


## Part 1

> __Theorem 1__:
> Given $p > 1$ odd, $p$ is good iff there exists positive integers $x, y < p$ coprime with $p$ such that $y > p/2 + x$ and $S_p(x) = S_p(y)$.
>
> __Proof__:
> First, suppose that such $x$ and $y$ exists.
> Take $a_1 = p + x$ and $a_2 = y$, so that $a_1$ and $a_2$ are coprime with $p$, $a_1 > a_2$ and $F_p(a_1) = p + 2x < 2y = F_p(a_2)$.
> Since $S_p(x) = S_p(y)$, one can check that $F_p^{kT}(a_1) > F_p^{kT}(a_2)$ but $F_p^{kT + 1}(a_1) < F_p^{kT + 1}(a_2)$ for all $k \geq 0$.
> Indeed, this follows from $F_p^{kT}(a_i) = a_i + k S_p(a_i)$ and $F_p^{kT + 1}(a_i) = F_p(a_i) + k S_p(a_i)$ for $i = 1, 2$.
>
> Conversely, suppose that $p$-alternating pair $(a_1, a_2)$ exists with $a_1$ and $a_2$ coprime with $p$.
> Since $F_p$ is injective, we have $a_1 \neq a_2$.
> Without loss of generality, we can assume $a_1 > a_2$, and by cutting of the first few terms, we can assume $F_p(a_1) < F_p(a_2)$.
> Write $a_i = q_i p + r_i$, $r_i < p$ for $i = 1, 2$.
> Then $r_1 = F_p(a_1) - a_1 < F_p(a_2) - a_2 = r_2$, and so $a_1 > a_2$ yields $q_1 > q_2$.
> Furthermore, $F_p(a_1) = q_1 p + 2 r_1 < q_2 p + 2 r_2 = F_p(a_2)$ yields $q_1 p < (q_2 + 2) p$, so $q_1 = q_2 + 1$.
> Then $F_p(a_1) < F_p(a_2)$ again yields $2 r_2 > p + 2 r_1 + p$, or $r_2 > p/2 + r_1$.
> Picking $x = r_1$ and $y = r_2$, it is clear that they are coprime with $p$ since $a_1$ and $a_2$ are.
> It remains to show that $S_p(r_1) = S_p(r_2)$, or equivalently $S_p(a_1) = S_p(a_2)$.
> But $S_p(a_1) \neq S_p(a_2)$ yields a contradiction by the previous lemma and the definition of $p$-alternating.
> Thus, we indeed have $S_p(a_1) = S_p(a_2)$.

Clearly, no $1$-alternating pairs exist.
So, it now suffices to show that the condition in Theorem 1 fails precisely when $p \in \{3, 7, 15\}$.
First, take $x = 1$ and $y = 2^k$ where $k = \lfloor \log_2 p \rfloor$, so that $2^k < p < 2^{k + 1}$.
Clearly, $S_p(1) = S_p(2^k)$, so it remains to show that $2^k > p/2 + 1 \iff 2^{k + 1} - 2 > p$.
Certainly, by definition of $k$ and the fact that $p$ is odd, this only fails if $p = 2^{k + 1} - 1$.
So, if $p + 1$ is not a power of $2$, we are done.

Now suppose that $p = 2^k - 1$ for some $k \geq 2$.
For $k \neq 2, 3, 4, 6$, we have $\phi(k) > 2$, so there exists a positive integer $c$ with $1 < c < k - 1$ and $c$ coprime with $k$.
We take $x = 2^c - 1$ and $y = 2^k - 2^{k - c} = 2^{k - c} (2^c - 1) = 2^{k - c} x$.
We have $\gcd(x, p) = 2^{\gcd(c, k)} - 1 = 1$, which also implies $\gcd(y, p) = 1$.
Clearly $S_p(x) = S_p(y)$, so it remains to prove that $x + p/2 < y \iff x + 2^{k - 1} \leq y \iff 2^{k - 1} > 2^{k - c} + 2^c$.
For $k \geq 5$ and $1 < c < k - 1$, we have $2^{k - c} + 2^c \leq 2^{k - 2} + 2^2 < 2^{k - 1}$.

It remains to consider the case where $p = 2^k - 1$ and $k \in \{2, 3, 4, 6\}$.
For $k = 6$, we can take $x = 5$, $y = 40$, and do the immediate check.
For $k = 2$, we have $p = 3$, and there exists no positive integers $x, y < p$ coprime with $p$ such that $y > p/2 + x$.
For $k = 3$, we have $p = 7$, and $S_p(x) = S_p(y)$ for $x, y < p$ coprime with $p$ iff they both belong in $\{1, 2, 4\}$ or $\{3, 5, 6\}$ simultaneously.
Both sets do not have two elements differing by greater than $7/2 > 3$.
For $k = 4$, we have $p = 11$, and $S_p(x) = S_p(y)$ for $x, y < p$ coprime with $p$ iff they both belong in $\{1, 2, 4, 8\}$ or $\{7, 11, 13, 14\}$ simultaneously.
Both sets do not have two elements differing by greater than $15/2 > 7$.


## Part 2

> __Theorem 2__:
> $p$ is balanced iff $S_p(x) = S_p(y)$ for every $x$ and $y$ coprime with $p$.
>
> __Proof__:
> First, suppose that $S_p(x) \neq S_p(y)$ for some $x$ and $y$ coprime with $p$.
> Without loss of generality, we can assume $S_p(x) < S_p(y)$.
> Take some $c$ large enough such that $x + cp > y$, if necessary, and note that $S_p(x + cp) < S_p(y)$.
> By the first lemma, there exists $N \geq 0$ such that $F_p^n(x + cp) < F_p^n(y)$ for all $n \geq N$.
> Assume that $N$ is chosen to be minimal with this property.
> Note that the inequality does not hold for $n = 0$, which also implies $N \geq 1$.
> Then taking $a_1 = F_p^{N - 1}(x + cp)$ and $a_2 = F_p^{N - 1}(y)$ works.
> Indeed, minimality of $N$ implies $a_1 \geq a_2$ and $F_p^n(a_1) < F_p^n(a_2)$ for all $n \geq 1$.
> The equality cannot hold in the first inequality since $F_p$ is injective.
>
> Conversely, suppose that $p$ is not balanced.
> Then there exists $a_1 > a_2$ coprime with $p$ such that $a_1 + S_p(a_1) = F_p^T(a_1) < F_p^T(a_2) = a_2 + S_p(a_2)$.
> This already implies $S_p(a_1) \neq S_p(a_2)$, a contradiction.

A slight note is that one can compute and obtain
$$ S_p(x) + S_p(y) = \sum_{k = 0}^{T - 1} (d_p(x) + d_p(y)) = \sum_{k = 0}^{T - 1} p = pT, $$
where $x$ and $y$ are any positive integers coprime to $p$ for which $p \mid x + y$.
Thus, $S_p(x) = S_p(y)$ for every $x$ and $y$ coprime with $p$ is equivalent to saying that $2 S_p(x) = pT$ for any $x$ coprime with $p$.

It remains to show that, if $p$ is prime, then $2 S_p(x) = pT$ for every $x$ and $y$ coprime with $p$ iff $T$ is even.
We will do the work in a more general setting.
That is, we will not assume that $p$ is prime until the last paragraph.

First, if $-1$ is a power of $2$ modulo $p$, then clearly $S_p(x) = S_p(y)$ for any $x$ and $y$ coprime with $p$ with $p \mid x + y$.
Then one can see that
$$ 2 S_p(x) = S_p(x) + S_p(y) = \sum_{k = 0}^{T - 1} (d_p(x) + d_p(y)) = \sum_{k = 0}^{T - 1} p = pT. $$
Meanwhile, if the $S_p(x)$ are all equal to $pT/2$, since $p$ is odd, $T$ must be even.

Finally, if $p$ is prime, then $T$ being even does imply that $-1$ is a power of $2$ modulo $p$.
So we get that $p$ is balanced iff $T$ is even iff $-1$ is a power of $2$ modulo $p$.



# Extra

When $p$ is not prime, $p$ could be balanced even if $-1$ is not a power of $2$ modulo $p$.
Some examples are $p = 69$ and $p = 141$.
In particular, being balanced is not divisor-closed.
Apparently, it is not even true that $p$ is balanced iff $rad(p)$ is balanced, with one example case being $p = 1827$, $rad(p) = 609$.



# Implementation details

We have quite a big result here, so we will use multiple `.lean` files.
The definition and basic properties of $F_p$ and $S_p$ are proved in `N4_basic.lean`.
Part 1 is solved in `N4_part1.lean`, while Part 2 is solved in `N4_part2.lean`.
Furthermore, we also prove in `N4_part2.lean` that primes congruent to $7 \pmod{8}$ are not balanced, while primes congruent to $3, 5 \pmod{8}$ are balanced.
In particular, using Dirichlet's theorem on arithmetic progressions, there exists infinitely many odd primes that are not balanced.

Instead of letting $S_p$ be just the sum of $T$ terms, we generalize to arbitrary number of terms.
This allows us to prove some properties by induction.

One result that is used in part 1 is that $\phi(n) \leq 2$ iff $n \leq 6$ and $n \neq 5$.
We will prove bounds on the totient function in an extra file `extra/number_theory/totient_bound.lean`.
