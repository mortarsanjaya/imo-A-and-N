# IMO 2020 N4, Generalized Version

Fix an odd prime number.
For any integer $n$, let $d_p(n) \in \{0, 1, \ldots, p - 1\}$ be the remainder when $n$ is divided by $p$, and denote $F_p(n) = n + d_p(n)$.

1. Prove that there exist positive integers $a_1$ and $a_2$ coprime with $p$ such that $F_p^n(a_1) > F_p^n(a_2)$ for infinitely many $n$ and $F_p^n(a_1) < F_p^n(a_2)$ for infinitely many $n$ as well, iff $p \neq 3, 7$.

2. Prove that there exist positive integers $a_1 > a_2$ coprime with $p$ such that $F_p^n(a_1) < F_p^n(a_2)$ for all $n \geq 1$ iff the order of $2$ modulo $p$ is even.



# Solution

Let $T$ denote the order of $2$ modulo $p$.
For both parts, we need to set up some notation.
For any $n \geq 0$, let $S_p(n) = \displaystyle \sum_{k = 0}^{T - 1} d_p(2^k n)$.
By order definition, $d_p(2^T n) = d_p(n)$, so one can check that $S_p(2n) = S_p(n)$.
Clearly, $S_p(n) = S_p(d_p(n))$ and $d_p(F_p(n)) = d_p(2n)$, so we also get $S_p(F_p(n)) = S_p(n)$.
In particular, we can prove by induction on $k$ that for all $k, r \geq 0$,
$$ F_p^{kT}(n) = n + k S_p(n). \tag{*} $$
The above equation is the key equation to solve both parts.
One remark to note is that one can show that $F_p$ is injective.
In particular, when $a_1 \neq a_2$, we have $F_p^n(a_1) \neq F_p^n(a_2)$ for all $n \geq 0$.


## Part 1

For the case $p \neq 3, 7$, the main step is the following lemma.
It helps us to choose a suitable $a_1$ and $a_2$.

> __Lemma__:
> Given a $p$ prime, $p \neq 3, 7$, there exists positive integers $x, y < p$ such that $y > p/2 + x$ and $S_p(x) = S_p(y)$.
>
> __Proof__:
> If $p \equiv 1 \pmod{4}$, set $x = 1$ and $y = \frac{3p + 1}{4}$.
> If $p \equiv 3 \pmod{4}$, set $x = 3$ and $y = \frac{3p + 3}{4}$ instead.
> One can verify that $y > p/2 + x$, and $S_p(x) = S_p(y)$ holds since $4y \equiv x \pmod{p}$.

Now set $a_1 = p + x$ and $a_2 = y$.
We claim that $F_p^{kT}(a_1) > F_p^{kT}(a_2)$ and $F_p^{kT + 1}(a_1) < F_p^{kT + 1}(a_2)$ for any $k \geq 0$.
Indeed, by (*), for $i = 1, 2$, we have
$$ F_p^{kT}(a_i) = a_i + k S_p(a_i), \quad F_p^{kT + 1}(a_i) = F_p(a_i) + k S_p(a_i) $$
Then the claim follows by $S_p(a_1) = S_p(a_2)$, $a_1 > a_2$, and $F_p(a_1) = p + 2x < 2y = F_p(a_2)$.

It remains to consider the case $p = 3, 7$.
In both of these cases, the main claim is that if $x < y$ are coprime with $p$ and $S_p(x) = S_p(y)$, then $F_p(x) < F_p(y)$.
For the case $p = 3$, we do not even need the equality $S_p(x) = S_p(y)$.

Suppose that there exists $x < y$ coprime with $p$ such that $F_p(x) \geq F_p(y)$.
Write $x = kp + r$ and $y = mp + s$, where $r = d_p(x)$ and $s = d_p(y)$.
Then $F_p(x) = kp + 2r$, $F_p(y) = mp + 2s$, and $F_p(x) \geq F_p(y)$ implies $r > s$.
Since $x < y$, we necessarily have $k < m$.
Then $F_p(x) \geq F_p(y)$ reads as $2(r - s) \geq (m - k)p$.
Note that $p > r > s > 0$, so $2(r - s) < p$, which means we must have $m = k + 1$ and $r \geq s + p/2$.
Inequality has to be strict as $p/2$ is not an integer.

For the case $p = 3$, this is a direct contradiction as $r \geq s + p/2$ implies $r \geq s + 2$, but $2 \geq r > s \geq 1$.
For the case $p = 7$, it turns out to be a contradiction with the extra equality $S_p(x) = S_p(y)$.
Indeed, this equality is equivalent to $S_p(r) = S_p(s)$, which means $r$ and $s$ must both belong to either $\{1, 2, 4\}$ or $\{3, 5, 6\}$.
Both of these sets do not contain two integers of difference at least $p/2$, so we get a contradiction.


## Part 2

The first condition is equivalent with the following condition: there exist positive integers $a_1 > a_2$ coprime with $p$ and $N \geq 1$ with $F_p^n(a_1) < F_p^n(a_2)$ for all $n \geq N$.
Indeed, for one direction, just take $N = 1$, while for the other direction, one just replace $a_1$ and $a_2$ by $F_p^K(a_1)$ and $F_p^K(a_2)$, where $K$ is the maximum non-negative integer such that $F_p^K(a_1) > F_p^K(a_2)$.
One subtle remark is that the maximality only directly gives us $F_p^n(a_1) \leq F_p^n(a_2)$ for all $n > K$.
But it is not hard to show that $F_p$ is injective, implying that this inequality must be strict.

We reduce the condition to another equivalent condition: there exist positive integers $x_1$, $x_2$ coprime with $p$ such that $S_p(x_1) \neq S_p(x_2)$.
First, suppose that such $a_1$ and $a_2$ as in the condition in the previous paragraph exists.
Then we can take $(x_1, x_2) = (a_1, a_2)$.
Note that $a_1 > a_2$ and $F_p^T(a_1) < F_p^T(a_2)$ implies $S_p(a_1) < S_p(a_2)$ by (*).
Conversely, suppose that there exists $x_1$ and $x_2$ coprime with $p$ such that $S_p(x_1) \neq S_p(x_2)$.
WLOG we may suppose that $S_p(x_1) < S_p(x_2)$.
Take $a_1 = x_1 + kp$ where $k$ is large enough such that $a_1 > x_2$, and take $a_2 = x_2$.
We take $K$ large enough such that $a_1 + (K + 1) S_p(x_1) < a_2 + K S_p(x_2)$.
This means we pick $K$ such that $F_p^{(K + 1)T}(x_1) < F_p^{T}(x_2)$.
We claim that $N = KT$ works.
Indeed, given some $n = kT + r$, where $k \geq K$ and $0 \leq r < p - 1$,
$$ F_p^n(x_1) \leq F_p^{(k + 1)T}(x_1) < F_p^{kT}(x_2) \leq F_p^n(x_2). $$
Note that the two non-strict inequalities follow since $F_p$ is strictly increasing.
The middle inequality follows by computation since $F_p^{(K + 1)T}(x_1) < F_p^{KT}(x_2)$.

Finally, we prove that $S_p(x_1) = S_p(x_2)$ for all $x_1$ and $x_2$ coprime with $p$ iff $T$ is even.
The main observation is that $S_p(x) + S_p(y) = pT$ for any $x, y$ coprime with $p$ such that $p \mid x + y$.
This holds just unfolding the sum and by the fact that $d_p(n) + d_p(-n) = p$ if $p \nmid n$.

First, suppose that $S_p(x_1) = S_p(x_2)$ for all $x_1$ and $x_2$ coprime with $p$.
In particular, $S_p(1) = S_p(p - 1)$, but we also have $S_p(1) + S_p(p - 1) = pT$.
So $pT$ is even, and thus $T$ is even, as desired.

For the converse, suppose that $T$ is even.
Then $2^{T/2} \equiv -1 \pmod{p}$.
In particular, if we let $y = p - d_p(x)$, then $y \equiv 2^{T/2} x \pmod{p}$.
So $S_p(x) = S_p(d_p(x)) = S_p(d_p(2^{T/2} x)) = S_p(d_p(y)) = S_p(y)$.
But this also means $p \mid x + y$ and thus $S_p(x) + S_p(y) = pT$.
As a result, we have $S_p(x) = pT/2$ for any $x$ coprime with $p$.
We are done.
