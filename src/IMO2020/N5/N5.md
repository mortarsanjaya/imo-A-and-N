# IMO 2020 N5, Generalized Version

Let $M$ be a torsion-free commutative (additive) cancellative monoid.
Let $\N^+ = \{1, 2, 3, \ldots\}$.
Determine all functions $f : \N^+ \to M$ such that
1. $f(xy) = f(x) + f(y)$ for every $x, y \in \N^+$,
2. there exists infinitely positive integers $n$ such that $f(k) = f(n - k)$ for all $k < n$.



# Answer

Either $f \equiv 0$, or $f = n \mapsto \nu_p(n) \cdot c$ for some $c \in M$ non-zero and $p$ prime.



# Solution

Given a function $f : \N^+ \to M$,
1. we call $f$ *additive* if $f(xy) = f(x) + f(y)$ for every $x, y \in \N^+$,
2. we say that $f$ is *$n$-good* for a positive integer $n$ if $f(k) = f(n - k)$ for all $k < n$,
3. we say that $f$ is *wide* if $f$ is $p$-good for infinitely many primes $p$,
4. for a prime $p$, we say that $f$ is *$p$-strong* if $f$ is $p^k$-good for every $k \geq 1$.
It is easy to check that for any $c \in M$ and $p$ prime, the map $f = n \mapsto \nu_p(n) c$ is additive and $f$ is $p$-strong.
For the latter, one just checks that $\nu_p(n) = \nu_p(p^k - n)$ for any $0 < n < p^k$.
Thus, it remains to show that these are all such functions.

Let $f : \N^+ \to M$ be an additive function.
It is easy to see that, for any positive integer $n$ with prime factorization $n = \displaystyle \prod_{i = 1}^k p_i^{a_i}$, we have $f(n) = \displaystyle \sum_{i = 1}^k a_i f(p_i)$.
In particular, one can prove that, for any positive integer $m$ such that $f$ is $m$-good, $f$ is also $d$-good for any factor $d$ of $m$.
We break into two cases using the following lemma.

> __Lemma 1__:
> Suppose that there are infinitely many positive integers $m$ for which $f$ is $m$-good.
> Then, $f$ is either wide or $p$-strong for some prime $p$.
>
> __Proof__:
> Suppose that $f$ is not $p$-strong for any prime $p$.
> For each prime $p$, there exists an integer $a_p \geq 0$ such that $f$ is $p^{a_p}$-good but not $p^{a_p + 1}$-good.
> Then for each positive integer $n$ for which $f$ is $n$-good, we have $\nu_p(n) \leq a_p$.
> If $f$ is not wide either, then $a_p = 0$ for all but finitely many $p$.
> But then every positive integer $n$ such that $f$ is $n$-good must divide $\prod_p p^{a_p} < \infty$.
> The product can be taken only over primes $p$ for which $f$ is $p$-good.
> A contradiction, showing that the lemma holds.

In both cases, the next lemma will help us proceed.
First, for any positive integer $m$, let $[m]_n$ denote the remainder of division of $m$ by $n$.

> __Lemma 2__:.
> Let $p$ be a prime for which $f$ is $p$-good.
> Then, for any positive integers $k, m < p$, we have $f([km]_p) = f(k) + f(m)$.
>
> __Proof__:
> Proceed by strong induction on $k$.
> The base case $k = 1$ is trivial.
> Now, given some $k_0 < p$, suppose that we have $f([km]_p) = f(k) + f(m)$ for all $k < k_0$ and $m < p$.
> Next, we use strong induction on $m$, with the base case $k_0 m < p$ being trivial.
> So, the induction step is now as follows: suppose that $k_0 m_0 \geq p$, $f([km]_p) = f(k) + f(m)$ holds for all $k < k_0$ and $m < p$, and also it holds for $k = k_0$ and for any $m < m_0$.
> We want to show that $f([k_0 m_0]_p) = f(k_0) + f(m_0)$.
>
> Let $k = \lfloor p/m_0 \rfloor < k_0 < p$.
> We can write $p = k m_0 + r$ for some positive integer $r < m_0$; note that $r$ cannot be zero.
> Since $r < m_0$, by induction hypothesis, we have $f([k_0 r]_p) = f(k_0) + f(r)$.
> But $r = p - k m_0$, so using induction hypothesis,
> $$ f([k_0 k m_0]_p) = f([-k_0 k m_0]_p) = f(k_0) + f(k m_0) = f(k_0) + f(k) + f(m_0). $$
> On the other hand, by induction hypothesis, $f([k_0 k m_0]_p) = f(k) + f([k_0 m_0]_p)$.
> Cancelling out $f(k)$ gives us the desired equality $f([k_0 m_0]_p) = f(k_0) + f(m_0)$.
> Induction step is complete; the lemma is proved.

As a corollary, we have the following result.

> __Lemma 3__:
> Let $p$ be a prime for which $f$ is $p$-good.
> Then we have $f(k) = 0$ for all $k < p$.
>
> __Proof__:
> Using Lemma 2 and induction, one can show that $f([k^m]_p) = m f(k)$ for any $k < p$ and $m \geq 0$.
> In particular, plugging $m = p - 1$ and using Fermat's little theorem gives us $(p - 1) f(k) = f(1) = 0$.
> Since $M$ is torsion-free, we get $f(k) = 0$.


## Case 1: $f$ is wide.

Lemma 3 trivializes this case.
Since $f$ is wide, there exists infinitely many primes $p$ for which $f$ is $p$-good.
Then, for any positive integer $k$, we can pick a prime $p > k$ for which $f$ is $p$-good.
Then Lemma 3 yields $f(k) = 0$.
This implies $f \equiv 0$.


## Case 2: $f$ is $p$-strong for some odd prime number $p$.

The following lemma, together with Lemma 3, solves this case.

> __Lemma 4__:
> Let $f : \N^+ \to M$ be a $p$-strong additive function.
> Then $f(n) = f([n]_p)$ for any positive integer $n$ coprime with $p$.
>
> __Proof__:
> Proceed by strong induction on $n$.
> The base case is $n < p$, for which the result is trivial since $[n]_p = n$.
> So now, let $n > p$, and suppose that $f(m) = f([m]_p)$ for any $m < n$.
>
> Let $a$ be the unique positive integer such that $p^a < n < p^{a + 1}$.
> Let $k = \lfloor p^{a + 1}/n \rfloor$.
> We have $k < p$ since $p^a < n$.
> Then we have $f(k) + f(n) = f(kn) = f(p^{a + 1} - kn)$, where $p^{a + 1} - kn < n$ by construction of $k$.
> But also, since $k < p$ and $\gcd(n, p) = 1$, we have $\gcd(p^{a + 1} - kn, p) = 1$.
> Applying induction hypothesis, we get $f(k) + f(n) = f([-kn]_p) = f([kn]_p)$.
> But since $k < p$, Lemma 2 gives us $f([kn]_p) = f(k) + f([n]_p)$.
> Cancelling $f(k)$ out from both sides gives us $f(n) = f([n]_p)$.
> Induction step is complete; the lemma is proved.

Indeed, by Lemma 3, $f(k) = 0$ for all $k < p$.
So, Lemma 4 yields $f(n) = 0$ for any $n$ coprime with $p$.
Then we get $f(n) = \nu_p(n) f(p)$ for all $n \in \N^+$; we are done.



# Extra

## $p$-strong homomorphisms

Lemma 2 and 4 in fact do not rely on $M$ being torsion-free.
Thus, the two lemmas also allow us to characterize $p$-strong homomorphisms even when the co-domain is not torsion-free.
Indeed, the $p$-strong homomorphisms can be precisely described by $f(p^k t) = k \cdot c + \chi(\overline{t})$ for some $c \in M$ constant and a monoid homomorphism $\chi : (\Z/\langle p \rangle)^* \to M$ with $\chi(-1) = 0$.
The character is not necessarily trivial when $M$ is not torsion-free; this is the only difference.


If $p$ is an odd prime, then one can instead use a homomorphism from $\Z/\langle \frac{p - 1}{2} \rangle$ (as an additive group) or $(\Z/\langle p \rangle)^* / \langle -1 \rangle$ to $M$ instead.)


## Wide homomorphisms

On the other hand, Lemma 3 relies on $M$ being torsion-free.
The case where $f$ is wide gets trivialized by Lemma 3.
On the other hand, there exists non-zero wide homomorphisms, for example, as follows.

> __Lemma 5__:
> There exists a wide non-zero function $\N^+ \to \Z/2\Z$.
>
> __Proof__:
> We define a sequence of primes $p_1 < p_2 < p_3 < p_4 < \ldots$ inductively as follows.
> First take $p_1 = 5$.
> Next, suppose that we have define $p_n$ for some $n \geq 1$.
> We take $p_{n + 1}$ to be a prime number greater than $p_n$ such that $\left(\frac{k}{p_{n + 1}}\right) = \left(\frac{k}{p_n}\right)$ for all $k < p_n$.
> We now show that such $p_{n + 1}$ must exist.
>
> It is well-known that $\left(\frac{a}{4a + b}\right) = \left(\frac{a}{b}\right)$ for all $a, b > 0$ with $\gcd(a, b) = 1$.
> As a result, for any $k < p_n$ and $a > 0$, we have
> $$ \left(\frac{k}{4a (p_n - 1)! + p_n}\right) = \left(\frac{k}{p_n}\right). $$
> But $4(p_n - 1)!$ is coprime with $p_n$ since $p_n \geq p_1 = 5$, so Dirichlet's theorem on arithmetic progressions mean that we can take $a > 0$ such that $a (p_n - 1)! + p_n$ is prime.
> We can then set $p_{n + 1} = a (p_n - 1)! + p_n$.
>
> By the property of the sequence, there exists a function $g : \N^+ \to \{-1, 1\}$ such that $g(k) = \left(\frac{k}{p_n}\right)$ for any $n \geq 1$ such that $k < p_n$.
> This function is multiplicative; for any $k$ and $m$, taking $n$ large enough gives us
> $$ g(k) g(m) = \left(\frac{k}{p_n}\right) \left(\frac{m}{p_n}\right) = \left(\frac{km}{p_n}\right) = g(km). $$
> We set $f(k) = 1$ if $g(k) = -1$ and $f(k) = 0$ if $g(k) = 1$.
> Working modulo $2$, since $g$ is multiplicative, $f$ is additive.
> Furthermore, for each $n \geq 1$, $f$ is $p_n$-good since one can also check that $g$ is $p_n$-good.
> Thus, $f$ is wide.
> But $f \neq 0$, since $f(2) = 1$.


## Distinction between wide and $p$-strong

Similar to uniqueness of characteristic of integral domains, a homomorphism $\N^+ \to M$ cannot be $p$-strong for multiple $p$ or simultaneously wide and $p$-strong for some $p$ prime.
To prove this, one proves the following simpler result.

> __Lemma 6__:
> Let $p$ be a prime, and let $f : \N^+ \to M$ be a $p$-strong homomorphism.
> Suppose that $f$ is $n$-good for some $n > p(p - 1)$ coprime with $p$.
> Then $f \equiv 0$.
>
> __Proof__:
> Since $f$ is $n$-good, for each $k < p$ we have $f(pk) = f(n - pk)$.
> But since $\gcd(n, p) = 1$ and $f$ is $p$-strong, Lemma 4 yields $f(n - pk) = f([n]_p)$, which does not depend on $k$.
> So, we get $f(p) + f(k) = f([n]_p) = f(p) + f(1) = f(p)$, which means $f(k) = 0$ for all $k < p$.
> But we also have $[n]_p < p$, so f([n]_p) = 1$.
> This means $f(p) = 0$, so $f(k) = 0$ for all $k \leq p$.
>
> Now, for any $n \in \N^+$, we can write $n = p^k t$ for some $k \geq 0$ and $t$ coprime with $p$.
> Lemma 4 yields $f(t) = f([t]_p) = 0$, so $f(n) = k f(p) + f(t) = 0$.
> This shows that $f(n) = 0$ for all $n \in \N^+$.

Now it is immediate that a non-trivial $p$-strong homomorphism cannot be $q$-strong for any $q \neq p$ and also cannot be wide.
For the former case, pick $N$ large enough such that $q^N > p^2$, then apply Lemma 6 with $f$ being $q^N$-good and $\gcd(q^N, p^2) = 1$ since $q \neq p$.
For the latter case, we can pick some $q > p^2$ such that $f$ is $q$-good and then apply Lemma 6 with $\gcd(q, p^2) = 1$ since $q \neq p$.



# Implementation details

There are a lot of structural results we could prove here.
We will need to divide them into sections:
1. A section for the definitions,
2. A section for basic lemmas,
3. A section for $p$-strong homomorphisms,
4. A section for wide homomorphisms,
5. A section for distinction between $p$-strong and wide,
6. A section for the final solution for the main section.

The basic lemmas are Lemma 1-3.
For $p$-strong homomorphisms, we prove Lemma 4 and fully characterize all $p$-strong homomorphisms as implications.
This includes giving a good construction of them.
For wide homomorphisms, we prove that it is trivial if $M$ is torsion-free and construct the non-trivial one given in Lemma 5 for $M = \{-1, 1\}$.
For distinction section, we prove Lemma 6 and 7.

While the problem asks for functions with domain $\N^+$, we work with $\N$ as a domain as `mathlib` has a better API with $\N$.
We tweak the definition of $n$-good function a bit: for any $n \geq 0$, we say that $f$ is $n$-good if $f(a) = f(b)$ for any *positive integers* $a$ and $b$ with $a + b = n$.
We also restrict $f(0) = 0$, as this preserves the following two things.
1. Each admissible functions have a unique description upon extending to $\N$.
2. The set of $p$-strong functions will still be a monoid with pointwise addition.
If $M$ is a group or a ring or so on, the set of $p$-strong functions will have even more structures as well.

To implement the restriction, one could, for example, use arithmetic functions in the final description of $p$-strong and wide functions.

## Note

It seems too hard to formalize the characterization of $p$-strong homomorphisms.
However, it is possible to get the prior necessary results working.

Formalizing the wide homomorphism construction seems impossible for now, as I am not aware of Dirichlet's theorem of arithmetic progressions being in `mathlib` at the time of writing.
Even the periodicity of Legendre symbol as a function of the top argument does not seem to be there.
(If one fixes $a$ in $\left(\frac{a}{p}\right)$, letting $p$ varied, then the value of $p \pmod{4a}$ is an invariant for the value of the Legendre symbol.)



# Comment

I think this generalized version could be of N6/N7 difficulty.
In arbitrary monoids (e.g. $\Z$), we cannot make use of the ordering property of $\N = \{0, 1, 2, \ldots\}$.
